# 发票全生命周期服务用户手册

## 引言

### 编写目的

为发票全生命周期服务接入方开发人员提供一个规范化的接口协议，更方便地进行业务整合嵌入。

### 背景

本协议适用于发票全生命周期服务与第三方接入平台间的行为、数据及事件的交互与传递。 本协议承载于 HTTP 协议，严格遵守 HTTP 协议规范。
### 定义

## 概述

接入方平台需要首先对接业务中台的运营网关（参考《clientId+secret调用api》），否则无法在线上使用本服务。
按照中台的规范，联调环境也要通过网关来调用本服务接口。
在使用本服务前，请向业务中台（tower@xforceplus.com）填写申请邮件接入，须提供接入方平台的app_id, tenant_id, company_id等。

## 产品简介 

### 什么是发票全生命周期服务

发票全生命周期服务是由服务下沉团队提供的增值税发票全票种生命周期监控，帮助企业查验发票真伪，实时准确获取发票真实状态，帮助
企业规避税务风险，实现流程闭环。


### 产品优势

+ 统一化的发票全生命周期服务功能接口
+ 支持自定义发票全生命周期服务器及属地化部署
+ 单Pod支持最少1000并发量
+ 支持按使用量弹性伸缩扩展
+ 按量付费，并提供折扣价套餐

### 产品功能

由服务下沉团队通过与票据中心的合作，实现发票的生命周期管理。

+ 支持税号底账的订阅
+ 支持发票的生命周期订阅
+ 支持订阅规则的管理
+ 支持发票生命周期的管理
+ 支持发票的详情查询

## 产品定价

### 计费方式

当前阶段全部免费。

### 赔付方案

待补充

## 接口清单

参考[《发票全生命周期服务接口样式》](/docs/发票全生命周期服务/发票全生命周期服务接口样式.md)

## 接入步骤
### 1.Jar包引入

<!--pom-->
```pom
<dependency>
    <groupId>com.xforceplus</groupId>
    <artifactId>invoice-lifecycle-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### 2.创建客户端
应用编写client接口类，继承xxxApi,并使用@FeignClient注解标识，调用服务示例代码如下

<!--java-->
```java
/**
 * 编写client,继承Api类
 */
@FeignClient(value = "invoice-server")
public interface InvoiceClient extends InvoiceApi{
}

/**
 * 注入刚编写的client,调用client方法即可
 */
@Autowired
private InvoiceClient invoiceClient;

public void test() {
InvoiceSubscribe invoiceSubscribe = createInvoiceSubscribe();  
Map<String, Object> params = JSON.parseObject(JSON.toJSONString(invoiceSubscribe));
        params.put("startTime", new Date());
        params.put("invoiceCode", invoiceSubscribe.getInvoiceCode() + random.nextInt(100));
        params.put("invoiceNo", invoiceSubscribe.getInvoiceCode() + random.nextInt(100));
        params.put("subscribeStyleValue", "invoice_lifecycle_test");
  ......
 invoiceClient.subscribeInvoices("tenantId","appId",Lists.newArrayList(params));
}

private InvoiceSubscribe createInvoiceSubscribe() {

        List<InvoiceSubscribe> invoiceSubscribes = JSON.parseArray("[\n" +
                "  {\n" +
                "    \"invoiceCode\": \"031001800311\",\n" +
                "    \"invoiceNo\": 56051741,\n" +
                "    \"paperDrewDate\": 20190802,\n" +
                "    \"checkCode\": 51566381412849030000,\n" +
                "    \"amount\": 170.9,\n" +
                "    \"taxNo\": \"91310000132149237G\",\n" +
                "    \"startTime\": \"2007-12-03T10:15:30+01:00\",\n" +
                "    \"subscribeStyle\": \"callback\",\n" +
                "    \"subscribeStyleValue\": \"invoice_lifecycle_test\",\n" +
                "    \"rule\": {\n" +
                "      \"ruleName\": \"发票状态规则\",\n" +
                "      \"ruleCode\": \"voicestatus\",\n" +
                "      \"period\": 180,\n" +
                "      \"perDayTimes\": 2,\n" +
                "      \"items\": [\n" +
                "        {\n" +
                "          \"fieldName\": \"status\",\n" +
                "          \"expectValue\": 1\n" +
                "        }\n" +
                "      ]\n" +
                "    }\n" +
                "  }\n" +
                "]", InvoiceSubscribe.class);
        RuleItem item = invoiceSubscribes.get(0).getRule().getItems().get(0);
        item.setFieldName("status");
        item.setExpectValue("2");
        return invoiceSubscribes.get(0);
    }
```

## 返回码清单
|  code  | message | 描述 | 
|  :----  | :----  |:----|
| INVCZZ0200 | 请求成功 | 附加返回参数请参看result内容 |
| INVCZZ0400 | 请求参数错误 | 请求参数校验失败，请按提示修改后重新提交 |
| INVCZZ0401 | 非法用户 | 重试多次后无法解决请联系管理员 |
| INVCZZ0404 | 对应记录未找到 | 重试多次后无法解决请联系管理员 |
| INVCZZ0500 | 服务器出现异常 | 重试多次后无法解决请联系管理员 |
| INVCZZ1001 | 第三方调用超时 | 重试多次后无法解决请联系管理员 |
| INVCZZ1002 | 第三方调用异常 | 重试多次后无法解决请联系管理员 |
| INVCZZ1003 | 请求第三方返回错误 | 重试多次后无法解决请联系管理员 |
| CPTNCB0001 | 回调接收成功 | 回调服务返回代码 |


## 测试环境

请联系我们获取测试环境信息

## 参考资料
[《发票全生命周期服务PRD》](https://wiki.xforceplus.com/pages/viewpage.action?pageId=36934941)

[《发票全生命周期服务ERD》](https://wiki.xforceplus.com/pages/viewpage.action?pageId=40075310)

[《clientId+secret调用api》](https://wiki.xforceplus.com/pages/viewpage.action?pageId=33463073)

## Q&A
* 1.订阅者如何接收发票信息?  

票易通会根据 订阅者提供的【接收发票信息的URL】、【申请的appId】 生成callbackID； 
订阅者在订阅发票时，订阅方式【subscribeStyle】为 callback， 订阅方式值【subscribeStyleValue】为 票易通生成的callbackID。
发票状态变更后，票易通会将信息POST提交到URL上。 订阅者接收到POST 请求后，状态码请返回 200.

POST 提交的body内容大致如下：
<!--java-->
```java
    
{
    "code": "CPTNCB0001",
    "message": "回调成功",
    "result": {
        "serialNo": "2019111301123705779Jf9KFpxmJt6s8",
        "data": "{\"code\":\"INVCZZ0200\",\"message\":\"请求成功\",\"result\":{\"invoiceDetails\":[{\"unitPrice\":\"108.1\",\"amountWithoutTax\":\"108.1\",\"itemSpec\":\" \",\"taxRate\":\"0\",\"quantity\":\"1\",\"cargoName\":\"*电信服务*通信服务费\",\"zeroTax\":\"3\",\"quantityUnit\":\"个\",\"taxAmount\":\"0\",\"amountWithTax\":\"108.1\"},{\"unitPrice\":\"-.2\",\"amountWithoutTax\":\"-.2\",\"itemSpec\":\" \",\"taxRate\":\"0\",\"quantity\":\"1\",\"cargoName\":\"*电信服务*消费折扣\",\"zeroTax\":\"3\",\"quantityUnit\":\"个\",\"taxAmount\":\"0\",\"amountWithTax\":\"-0.2\"}],\"invoiceMain\":{\"cpyStatus\":\"0\",\"sellerName\":\"中国移动通信集团上海有限公司\",\"remark\":\"账户号：10036308356，账单月：201907，发票金额不包含赠费和积分兑换0.2元。\",\"purchaserBankInfo\":\" \",\"sellerBankInfo\":\"022540-工行市分行营业部，1001254009005439422\",\"sellerAddrTel\":\"上海市长寿路200号13800210021\",\"invoiceType\":\"ce\",\"ctStatus\":\"\",\"invoiceNo\":\"03100180012345\",\"redFlag\":\"0\",\"amountWithoutTax\":\"107.9\",\"checkNumber\":\"5\",\"machineCode\":\"661619990641\",\"dqCode\":\"3100\",\"invoiceCode\":\"03100180054321\",\"purchaserName\":\"李学锟\",\"checkCode\":\"51566381412849035892\",\"sellerTaxNo\":\"91310000132149237G\",\"checkTime\":\"2019-10-25 10:22:11\",\"purchaserTaxNo\":\" \",\"purchaserAddrTel\":\"13774392605\",\"dqName\":\"上海\",\"paperDrewDate\":\"20190802\",\"taxAmount\":\"0\",\"amountWithTax\":\"107.9\",\"taskId\":\"0ac046b9-9e36-4e19-aeb4-0521544789f4\",\"goodsListFlag\":\"0\",\"status\":\"2\"}}}"
    }
}

```
* 2.订阅规则这些接口订阅者需要对接吗? 
 
 需要对接。
 
 情景一：订阅者在订阅发票时，把订阅规则的相关参数一块传入；订阅成功后，会生成对应的订阅规则。  
 情景二：订阅者对订阅规则进行维护，在订阅发票时只需要传入ruleCode 参数即可。
 
* 3.发票属性说明

<!--java-->
```java

{
  "code":"INVCZZ0200" ,
  "message":"请求成功",
  "result":{
         "invoiceMain": {
                                    "invoiceType":" ", //发票类型 s-增值税专用发票、c-增值普通发票，ce-增值税电子普通发票
                                    "invoiceCode":" ", //发票代码
                                    "invoiceNo":" ", //发票号码
                                    "paperDrewDate":" ", //开票日期
                                    "purchaserName":" ", //购方名称
                                    "purchaserTaxNo":" ", //购方税号
                                    "purchaserAddrTel":" ", //购方地址 电话
                                    "purchaserBankInfo":" ", //购方开户行名称 账号
                                    "sellerName":" ", //销方名称
                                    "sellerTaxNo":" ", //销方税号
                                    "sellerAddrTel":" ", //销方地址 电话
                                    "sellerBankInfo":" ", //销方开户行名称 账号
                                    "amountWithoutTax":" ", //发票不含税金额
                                    "taxAmount":" ", //发票税额
                                    "amountWithTax":" ", //发票含税金额
                                    "machineCode":" ", //机器码
                                    "checkCode":" ", //校验码
                                    "remark":" ", //备注
                                    "status":" ", //发票状态 1-正常、0-作废
                                    "redFlag":" ", //红冲状态 0-未红冲、1-已被红冲
                                    "cpyStatus":" ", //成平油标志 0-非成品油发票 1-成品油发票
                                    "ctStatus":" ", //通行费标志 0-普通通行费 1-特殊通行费 (通道二不支持)
                                    "checkNumber":" ", //查验次数 (通道二不支持)
                                    "checkTime":" ", //查验时间 yyyy-MM-dd HH:mm:ss
                                    "goodsListFlag":"", //销货清单标志 0-无销货清单，1-有销货清单
                                    "dqCode":" ", //地区代码
                                    "dqName":" " //地区名称
        },
    "invoiceDetails": [
      {
                                    "cargoName":" ", //货物及服务名称
                                    "itemSpec":" ", //型号规格
                                    "quantityUnit":" ", //数量单位
                                    "quantity":" ", //数量
                                    "unitPrice":" ", //单价
                                    "taxRate":" ", //税率
                                    "zeroTax":" ", //零税率标志 空-非0税率；0-出口退税1-免税2-不征税3-普通0税率
                                    "amountWithoutTax":" ", //不含税金额
                                    "taxAmount":" ", //税额
                                    "amountWithTax":" " //含税金额
         },{...}]
   }
}
```

区块链发票
```
{
  "code":"INVCZZ0200" ,
  "message":"请求成功", //处理备注说明
  "result":{
      "invoiceMain": {
                                    "invoiceType":" ", //发票类型 cb-增值税电子普通发票（区块链）
                                    "invoiceCode":" ", //发票代码
                                    "invoiceNo":" ", //发票号码
                                    "paperDrewDate":" ", //开票日期
                                    "purchaserName":" ", //购方名称
                                    "purchaserTaxNo":" ", //购方税号
                                    "purchaserAddrTel":" ", //购方地址 电话
                                    "purchaserEPayId":" ", //电子支付标识
                                    "sellerName":" ", //销方名称
                                    "sellerTaxNo":" ", //销方税号
                                    "sellerAddrTel":" ", //销方地址 电话
                                    "sellerBankInfo":" ", //销方开户行名称 账号
                                    "amountWithoutTax":" ", //发票不含税金额
                                    "taxAmount":" ", //发票税额
                                    "amountWithTax":" ", //发票含税金额
                                    "checkCode":" ", //校验码
                                    "remark":" ", //备注
                                    "status":" ", //发票状态 0-作废、1-正常、4-已报销
                                    "redFlag":" ", //红冲状态 0-未红冲、1-已被红冲
                                    "checkNumber":" ", //查验次数 (通道二不支持)
                                    "checkTime":" ", //查验时间 yyyy-MM-dd HH:mm:ss
                                    "goodsListFlag":"", //销货清单标志 0-无销货清单，1-有销货清单
                                    "dqCode":" ", //地区代码
                                    "dqName":" " //地区名称
   },
      "invoiceDetails": [
            {
                                    "cargoName":" ", //货物及服务名称
                                    "itemSpec":" ", //型号规格
                                    "quantityUnit":" ", //数量单位
                                    "quantity":" ", //数量
                                    "unitPrice":" ", //单价
                                    "taxRate":" ", //税率
                                    "zeroTax":" ", //零税率标志 空-非0税率；0-出口退税1-免税2-不征税3-普通0税率
                                    "amountWithoutTax":" ", //不含税金额
                                    "taxAmount":" ", //税额
                                    "amountWithTax":" " //含税金额
           },{...}]
   }
}
```


机动车发票
```
{
  "code":"INVCZZ0200" ,
  "message":"请求成功", //处理备注说明
  "result":{
       "invoiceMain": {
                                    "invoiceType":" ", //发票类型 j-机动车增值税专用发票
                                    "invoiceCode":" ", //发票代码
                                    "invoiceNo":" ", //发票号码
                                    "paperDrewDate":" ", //开票日期
                                    "machineCode":" ", //机器编码
                                    "purchaserName":" ", //购方名称
                                    "purchaserTaxNo":" ", //购方税号
                                    "amountWithoutTax":" ", //不含税金额
                                    "taxAmount":" ", //税额
                                    "amountWithTax":" ", //含税金额
                                    "sellerName":" ", //销方名称
                                    "sellerTaxNo":" ", //销方税号
                                    "sellerAddrTel":" ", //销方地址 电话
                                    "sellerBankInfo":" ", //销方开户行名称 账号
                                    "sellerAddress":" ", //销方地址
                                    "sellerTel":" ", //销方电话
                                    "sellerBankName":" ", //销方银行账号
                                    "sellerBankAccount":" ", //销方银行账号
                                    "purchaserId":" ", //身份证号码、组织机构码
                                    "vehicleType":" ", //车辆类型
                                    "vehicleBrand":" ", //厂牌型号
                                    "productionArea":" ", //产地
                                    "certificationNo":" ", //合格证号
                                    "commodityInspectionNo":" ", //商检单号
                                    "engineNo":" ", //发动机号码
                                    "vehicleNo":" ", //车辆识别代号/车架号码
                                    "importCertificateNo":" ", //进口证明书号
                                    "taxRate":" ", //征收税率
                                    "chargeTaxAuthorityCode":" ", //税务机关代码
                                    "chargeTaxAuthorityName":" ", //税务机关名称
                                    "taxPaidProof":" ", //完税凭证号码
                                    "tonnage":" ", //吨位，可能带小数
                                    "maxCapacity":" ", //限乘人数
                                    "status":" ", //发票状态 1：正常、0：作废
                                    "checkNumber":" ", //查验次数 (通道二不支持)
                                    "checkTime":" ", //查验时间 yyyy-MM-dd HH:mm:ss
                                    "dqCode":" ", //地区代码
                                    "dqName":" " //地区名称
                  }
       }
}
```


卷票
```
{
  "code":"INVCZZ0200",
  "message":"请求成功",
  "result":{
      "invoiceMain": {
                                    "invoiceType":" ", //发票类型 cj-增值税普通发票（卷票）
                                    "invoiceCode":" ", //发票代码
                                    "invoiceNo":" ", //发票号码
                                    "paperDrewDate":" ", //开票日期
                                    "sellerName":" ", //销方名称
                                    "sellerTaxNo":" ", //销方税号
                                    "purchaserName":" ", //购方名称
                                    "purchaserTaxNo":" ", //购方税号
                                    "machineCode":" ", //机器码
                                    "checkCode":" ", //校验码
                                    "amountWithTax":" ", //价税合计
                                    "receivingClerk":" ", //收货员
                                    "remark":" ", //备注
                                    "status":" ", //发票状态 1：正常、0：作废
                                    "redFlag":" ", //红冲状态 0-未红冲、1-已被红冲
                                    "cpyStatus":" ", //成平油标志 0-非成品油发票 1-成品油发票
                                    "checkNumber":" ", //查验次数
                                    "checkTime":" ", //查验时间 yyyy-MM-dd HH:mm:ss
                                    "dqCode":" ", //地区代码
                                    "dqName":" " //地区名称
            },
      "invoiceDetails": [{
                                    "cargoName":" ", //费用项目
                                    "quantity":" ", //数量
                                    "unitPrice":" ", //含税单价
                                    "amountWithTax":" ", //含税金额
         },{...}]
    }
}
```


通行费发票
```
{
   "code":"INVCZZ0200" ,
  "message":"请求成功",
   "result":{
        "invoiceMain": {
                                    "invoiceType":" ", //发票类型 ct-增值税电子普通发票（通行费）
                                    "invoiceCode":" ", //发票代码
                                    "invoiceNo":" ", //发票号码
                                    "paperDrewDate":" ", //开票日期
                                    "purchaserName":" ", //购方名称
                                    "purchaserTaxNo":" ", //购方税号
                                    "purchaserAddrTel":" ", //购方地址 电话
                                    "purchaserBankInfo":" ", //购方开户行名称 账号
                                    "sellerName":" ", //销方名称
                                    "sellerTaxNo":" ", //销方税号
                                    "sellerAddrTel":" ", //销方地址 电话
                                    "sellerBankInfo":" ", //销方开户行名称 账号
                                    "amountWithoutTax":" ", //发票不含税金额
                                    "taxAmount":" ", //发票税额
                                    "amountWithTax":" ", //发票含税金额
                                    "machineCode":" ", //机器码
                                    "checkCode":" ", //校验码
                                    "remark":" ", //备注
                                    "status":" ", //发票状态 1-正常、0-作废
                                    "redFlag":" ", //红冲状态 0-未红冲、1-已被红冲
                                    "ctStatus":" ", //通行费标志 0-普通通行费 1-特殊通行费
                                    "checkNumber":" ", //查验次数
                                    "checkTime":" ", //查验时间 yyyy-MM-dd HH:mm:ss
                                    "dqCode":" ", //地区代码
                                    "dqName":" " //地区名称
      },
    "invoiceDetails": [{
                                    "cargoName":" ", //项目名称
                                    "LicensePlateNum":" ", //车牌号
                                    "Type":" ", //类型
                                    "CurrentDateStart":" ", //通行日期起
                                    "CurrentDateEnd":" ", //通行日期止
                                    "taxRate":" ", //税率
                                    "zeroTax":" ", //零税率标志 空-非0税率；0-出口退税1-免税2-不征税3-普通0税率
                                    "amountWithoutTax":" ", //不含税金额
                                    "taxAmount":" ", //税额
                                    "amountWithTax":" " //含税金额
         },{...}]
     }
}
```


二手车发票
```
{
  "code": "INVCZZ0200" ,
  "message": "请求成功",
      "result":{
                                    "invoiceMain": {
                                    “invoiceType":" ", //发票类型 vs-二手车销售统一发票
                                    “invoiceCode":" ", //发票代码
                                    “invoiceNo":" ", //发票号码
                                    “paperDrewDate":" ", //开票日期
                                    “machineCode":" ", //机器编码
                                    “purchaserName":" ", // 买方单位/个人
                                    “purchaserTaxNo":" ", // 买方单位代码/身份证号
                                    “purchaserAddress":" ", // 买方单位/个人住址
                                    “purchaserTel":" ", // 买方电话
                                    “carNumber":" ", // 车牌照号
                                    “registrationNo":" ", // 登记证号
                                    “vehicleType":" ", // 车辆类型
                                    “totalPrice":" ", // 车价合计
                                    “vehicleNo":" ", // 车辆识别代号/车架号码
                                    “vehicleBrand":" ", // 厂牌型号
                                    “vehiclePlaceName":" ", // 转入地车辆车管所名称
                                    “sellerName":" ", // 卖方单位/个人
                                    “sellerTaxNo":" ", // 卖方单位代码/身份证号
                                    “sellerAddress":" ", // 卖方单位/个人住址
                                    “sellerTel":" ", // 卖方电话
                                    “auctioneersName":" ", // 经营、拍卖单位
                                    “auctioneersAddress":" ", // 经营、拍卖单位地址
                                    “auctioneersTaxNo":" ", // 经营、拍卖单位纳税人识别号
                                    “auctioneersBankInfo":" ", // 经营、拍卖单位开户银行及账号
                                    “auctioneersTel":" ", // 经营、拍卖单位电话
                                    “usedCarMarketName":" ", // 二手车市场
                                    “usedCarMarketTaxNo":" ", // 二手车市场纳税人识别号
                                    “usedCarMarketAddress":" ", // 二手车市场地址
                                    “usedCarMarketBankInfo":" ", // 二手车市场开户银行及账号
                                    “usedCarMarketTel":" ", // 二手车市场电话
                                    “remark":" ", // 备注
                                    “status":" ", // 发票状态 1：正常、0：作废
                                    "redFlag":" ", //红冲状态 0-未红冲、1-已被红冲
                                    “checkNumber":" ", // 查验次数
                                    “checkTime":" ", // 查验时间 yyyy-MM-dd HH:mm:ss
                                    “dqCode":" ", // 地区代码
                                    “dqName":" " // 地区名称
         }
    }
}

```
## 联系方式
tower@xforceplus.com