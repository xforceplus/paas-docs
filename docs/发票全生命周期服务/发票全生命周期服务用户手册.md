# 发票全生命周期服务用户手册

## 引言

### 编写目的

为发票全生命周期服务接入方开发人员提供一个规范化的接口协议，更方便地进行业务整合嵌入。

### 背景

本协议适用于发票全生命周期服务与第三方接入平台间的行为、数据及事件的交互与传递。 本协议承载于 HTTP 协议，严格遵守 HTTP 协议规范。
### 定义

## 概述

接入方平台需要首先对接业务中台的运营网关（参考《clientId+secret调用api》），否则无法在线上使用本服务。
按照中台的规范，联调环境也要通过网关来调用本服务接口。
在使用本服务前，请向业务中台（tower@xforceplus.com）填写申请邮件接入，须提供接入方平台的app_id, tenant_id, company_id等。

## 产品简介 

### 什么是发票全生命周期服务

发票全生命周期服务是由服务下沉团队提供的增值税发票全票种生命周期监控，帮助企业查验发票真伪，实时准确获取发票真实状态，帮助
企业规避税务风险，实现流程闭环。


### 产品优势

+ 统一化的发票全生命周期服务功能接口
+ 支持自定义发票全生命周期服务器及属地化部署
+ 单Pod支持最少1000并发量
+ 支持按使用量弹性伸缩扩展
+ 按量付费，并提供折扣价套餐

### 产品功能

由服务下沉团队通过与票据中心的合作，实现发票的生命周期管理。

+ 支持税号底账的订阅
+ 支持发票的生命周期订阅
+ 支持订阅规则的管理
+ 支持发票生命周期的管理
+ 支持发票的详情查询

## 产品定价

### 计费方式

当前阶段全部免费。

### 赔付方案

待补充

## 接口清单

参考[《发票全生命周期服务接口样式》](/docs/发票全生命周期服务/发票全生命周期服务接口样式.md)

## 接入步骤
### 1.Jar包引入

<!--pom-->
```pom
<dependency>
    <groupId>com.xforceplus</groupId>
    <artifactId>invoice-lifecycle-api</artifactId>
    <version>1.0-SNAPSHOT</version>
</dependency>
```

### 2.创建客户端
应用编写client接口类，继承xxxApi,并使用@FeignClient注解标识，调用服务示例代码如下

<!--java-->
```java
/**
 * 编写client,继承Api类
 */
@FeignClient(value = "invoice-server")
public interface InvoiceClient extends InvoiceApi{
}

/**
 * 注入刚编写的client,调用client方法即可
 */
@Autowired
private InvoiceClient invoiceClient;

public void test() {
InvoiceSubscribe invoiceSubscribe = createInvoiceSubscribe();  
Map<String, Object> params = JSON.parseObject(JSON.toJSONString(invoiceSubscribe));
        params.put("startTime", new Date());
        params.put("invoiceCode", invoiceSubscribe.getInvoiceCode() + random.nextInt(100));
        params.put("invoiceNo", invoiceSubscribe.getInvoiceCode() + random.nextInt(100));
        params.put("subscribeStyleValue", "invoice_lifecycle_test");
  ......
 invoiceClient.subscribeInvoices("tenantId","appId",Lists.newArrayList(params));
}

private InvoiceSubscribe createInvoiceSubscribe() {

        List<InvoiceSubscribe> invoiceSubscribes = JSON.parseArray("[\n" +
                "  {\n" +
                "    \"invoiceCode\": \"031001800311\",\n" +
                "    \"invoiceNo\": 56051741,\n" +
                "    \"paperDrewDate\": 20190802,\n" +
                "    \"checkCode\": 51566381412849030000,\n" +
                "    \"amount\": 170.9,\n" +
                "    \"taxNo\": \"91310000132149237G\",\n" +
                "    \"startTime\": \"2007-12-03T10:15:30+01:00\",\n" +
                "    \"subscribeStyle\": \"callback\",\n" +
                "    \"subscribeStyleValue\": \"invoice_lifecycle_test\",\n" +
                "    \"rule\": {\n" +
                "      \"ruleName\": \"发票状态规则\",\n" +
                "      \"ruleCode\": \"voicestatus\",\n" +
                "      \"period\": 180,\n" +
                "      \"perDayTimes\": 2,\n" +
                "      \"items\": [\n" +
                "        {\n" +
                "          \"fieldName\": \"status\",\n" +
                "          \"expectValue\": 1\n" +
                "        }\n" +
                "      ]\n" +
                "    }\n" +
                "  }\n" +
                "]", InvoiceSubscribe.class);
        RuleItem item = invoiceSubscribes.get(0).getRule().getItems().get(0);
        item.setFieldName("status");
        item.setExpectValue("2");
        return invoiceSubscribes.get(0);
    }
```

## 返回码清单
|  code  | message | 描述 | 
|  :----  | :----  |:----|
| INVCZZ0200 | 请求成功 | 附加返回参数请参看result内容 |
| INVCZZ0400 | 请求参数错误 | 请求参数校验失败，请按提示修改后重新提交 |
| INVCZZ0401 | 非法用户 | 重试多次后无法解决请联系管理员 |
| INVCZZ0404 | 对应记录未找到 | 重试多次后无法解决请联系管理员 |
| INVCZZ0500 | 服务器出现异常 | 重试多次后无法解决请联系管理员 |
| INVCZZ1001 | 第三方调用超时 | 重试多次后无法解决请联系管理员 |
| INVCZZ1002 | 第三方调用异常 | 重试多次后无法解决请联系管理员 |
| INVCZZ1003 | 请求第三方返回错误 | 重试多次后无法解决请联系管理员 |
| CPTNCB0001 | 回调接收成功 | 回调服务返回代码 |


## 测试环境

请联系我们获取测试环境信息

## 参考资料
[《发票全生命周期服务PRD》](https://wiki.xforceplus.com/pages/viewpage.action?pageId=36934941)

[《发票全生命周期服务ERD》](https://wiki.xforceplus.com/pages/viewpage.action?pageId=40075310)

[《clientId+secret调用api》](https://wiki.xforceplus.com/pages/viewpage.action?pageId=33463073)

## Q&A
1. 订阅者如何接收发票信息?  
票易通会根据 订阅者提供的【接收发票信息的URL】、【申请的appId】 生成ruleName； 
订阅者在订阅发票时，订阅方式【subscribeStyle】为 callback， 订阅方式值【subscribeStyleValue】为 票易通生成的ruleName。
发票状态变更后，票易通会将信息POST提交到URL上。 订阅者接收到POST 请求后，状态码请返回 200.

POST 提交的body内容大致如下：
<!--java-->
```java
    
{
    "code": "CPTNCB0001",
    "message": "回调成功",
    "result": {
        "serialNo": "2019111301123705779Jf9KFpxmJt6s8",
        "data": "{\"code\":\"INVCZZ0200\",\"message\":\"请求成功\",\"result\":{\"invoiceDetails\":[{\"unitPrice\":\"108.1\",\"amountWithoutTax\":\"108.1\",\"itemSpec\":\" \",\"taxRate\":\"0\",\"quantity\":\"1\",\"cargoName\":\"*电信服务*通信服务费\",\"zeroTax\":\"3\",\"quantityUnit\":\"个\",\"taxAmount\":\"0\",\"amountWithTax\":\"108.1\"},{\"unitPrice\":\"-.2\",\"amountWithoutTax\":\"-.2\",\"itemSpec\":\" \",\"taxRate\":\"0\",\"quantity\":\"1\",\"cargoName\":\"*电信服务*消费折扣\",\"zeroTax\":\"3\",\"quantityUnit\":\"个\",\"taxAmount\":\"0\",\"amountWithTax\":\"-0.2\"}],\"invoiceMain\":{\"cpyStatus\":\"0\",\"sellerName\":\"中国移动通信集团上海有限公司\",\"remark\":\"账户号：10036308356，账单月：201907，发票金额不包含赠费和积分兑换0.2元。\",\"purchaserBankInfo\":\" \",\"sellerBankInfo\":\"022540-工行市分行营业部，1001254009005439422\",\"sellerAddrTel\":\"上海市长寿路200号13800210021\",\"invoiceType\":\"ce\",\"ctStatus\":\"\",\"invoiceNo\":\"03100180012345\",\"redFlag\":\"0\",\"amountWithoutTax\":\"107.9\",\"checkNumber\":\"5\",\"machineCode\":\"661619990641\",\"dqCode\":\"3100\",\"invoiceCode\":\"03100180054321\",\"purchaserName\":\"李学锟\",\"checkCode\":\"51566381412849035892\",\"sellerTaxNo\":\"91310000132149237G\",\"checkTime\":\"2019-10-25 10:22:11\",\"purchaserTaxNo\":\" \",\"purchaserAddrTel\":\"13774392605\",\"dqName\":\"上海\",\"paperDrewDate\":\"20190802\",\"taxAmount\":\"0\",\"amountWithTax\":\"107.9\",\"taskId\":\"0ac046b9-9e36-4e19-aeb4-0521544789f4\",\"goodsListFlag\":\"0\",\"status\":\"2\"}}}"
    }
}

```


## 联系方式
tower@xforceplus.com